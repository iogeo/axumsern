<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
          "http://www.w3.org/TR/html4/loose.dtd">
<head>
    <script src='ffmpeg.min.js'></script>
</head>
<body>
    <p>
        <span id=rqqwr></span>
    </p>
    <video controls width="640" height="480" id="wq" muted hidden></video>
    <p>
        <button id=rqqw>Record</button>
    </p>
    <canvas id="canvas" width="640" height="480"></canvas>
    <canvas id="canvas2" width="640" height="480" hidden></canvas>
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        var rp;
        var rppq = "mousedown";
        var streamrq;
        var streamq = navigator.mediaDevices.getUserMedia({ audio: true, video: { width: 640, height: 480, frameRate: 30 } })
            .then(function (stream) {
                streamq = stream;
                if ("srcObject" in wq) {
                    wq.srcObject = stream;
                } else {
                    wq.src = window.URL.createObjectURL(stream);
                }
                wq.onloadedmetadata = function (e) {
                    wq.play();
                    streamrq = setInterval(function () {
                        ctx.drawImage(wq, 0, 0, wq.width, wq.height);
                    }, 3);
                }
            });
        var wqqi = [];
        var wqq2 = [];
        var wqq3 = [];
        const rqqwr = document.getElementById('rqqwr');
        var rpqqw = performance.now();
        const rpqw = setInterval(function () {
        }, 33);
        const canvas = document.getElementById('canvas');
        const canvas2 = document.getElementById('canvas2');
        const ctx = canvas.getContext('2d');
        const ctx2 = canvas2.getContext('2d');
        const rqqw = document.getElementById('rqqw');
        var mediaRecorder;
        var wq = document.getElementById('wq');
        async function qw() {
            document.getElementById('rqqw').innerText = "End intro";
            var options = { mimeType: "video/webm" };
            mediaRecorder = new MediaRecorder(streamq, options);
            mediaRecorder.start();
            rqqw.removeEventListener(rppq, qw);
            qww2();
            wq.play();
            clearInterval(streamrq);
            ctx2.globalAlpha = 0.4;
            ctx2.drawImage(wq, 0, 0, wq.width, wq.height);
            setInterval(function () {
                ctx.drawImage(wq, 0, 0, wq.width, wq.height);
                ctx.drawImage(canvas2, 0, 0, wq.width, wq.height);
            }, 3);
            wq.onloadedmetadata = "";
        }
        async function qw2() {
            document.getElementById('rqqw').innerText = "End waiting";
            qww3();
            wq.play();
            wq.onloadedmetadata = "";
        }
        async function qw3() {
            document.getElementById('rqqw').innerText = "End A";
            qww4();
            wq.play();
            wq.onloadedmetadata = "";
        }
        async function qw4() {
            document.getElementById('rqqw').innerText = "End B";
            wq.play();
            clearInterval(streamrq);
            qww();
            wq.onloadedmetadata = "";
        }
        async function qw5() {
            document.getElementById('rqqw').innerText = "";
        }
        rqqw.addEventListener(rppq, qw);
    </script>
    <script>
        function qww2() {
            rqqw.addEventListener(rppq, async function w() {
                var rp = 0;
                var cq = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                var cq2 = ctx2.getImageData(0, 0, canvas.width, canvas.height).data;
                for (var wrq = 0; wrq < cq.length; wrq += 1) {
                    if (cq[wrq] - cq2[wrq] > 49 || cq[wrq] - cq2[wrq] < -49)
                        rp += 1;
                    wrq += 1;
                }
                if (rp < 2348) {
                    function handleDataAvailable(event) {
                        if (event.data.size > 0) {
                            wqqi.push(event.data);
                            qw2();
                            rqqw.removeEventListener(rppq, w);
                            rqqwr.innerText = "";
                        } else {
                            // ...
                        }
                    }
                    mediaRecorder.ondataavailable = handleDataAvailable;
                    mediaRecorder.stop();
                    var options = { mimeType: "video/webm" };
                    mediaRecorder = new MediaRecorder(streamq, options);

                    mediaRecorder.start();

                }
                else
                    rqqwr.innerText = "Please respect the onion.";
            });
        }
        function qww3() {
            rqqw.addEventListener(rppq, async function w() {
                var rp = 0;
                var cq = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                var cq2 = ctx2.getImageData(0, 0, canvas.width, canvas.height).data;
                for (var wrq = 0; wrq < cq.length; wrq += 1) {
                    if (cq[wrq] - cq2[wrq] > 49 || cq[wrq] - cq2[wrq] < -49)
                        rp += 1;
                    wrq += 1;
                }
                if (rp < 2348) {
                    function handleDataAvailable(event) {
                        if (event.data.size > 0) {
                            wqq2.push(event.data);
                            qw3();
                            rqqw.removeEventListener(rppq, w);
                            rqqwr.innerText = "";
                        } else {
                            // ...
                        }
                    }
                    mediaRecorder.ondataavailable = handleDataAvailable;
                    mediaRecorder.stop();
                    var options = { mimeType: "video/webm" };
                    mediaRecorder = new MediaRecorder(streamq, options);

                    mediaRecorder.start();

                }
                else
                    rqqwr.innerText = "Please respect the onion.";
            });
        }
        function qww4() {
            rqqw.addEventListener(rppq, async function w() {
                var rp = 0;
                var cq = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                var cq2 = ctx2.getImageData(0, 0, canvas.width, canvas.height).data;
                for (var wrq = 0; wrq < cq.length; wrq += 1) {
                    if (cq[wrq] - cq2[wrq] > 49 || cq[wrq] - cq2[wrq] < -49)
                        rp += 1;
                    wrq += 1;
                }
                if (rp < 2348) {
                    function handleDataAvailable(event) {
                        if (event.data.size > 0) {
                            wqq3.push(event.data);
                            qw4();
                            rqqw.removeEventListener(rppq, w);
                            rqqwr.innerText = "";
                        } else {
                            // ...
                        }
                    }
                    mediaRecorder.ondataavailable = handleDataAvailable;
                    mediaRecorder.stop();
                    var options = { mimeType: "video/webm" };
                    mediaRecorder = new MediaRecorder(streamq, options);

                    mediaRecorder.start();

                }
                else
                    rqqwr.innerText = "Please respect the onion.";
            });
        }
        function qww() {
            mediaRecorder.stop();
            var canvas = document.querySelector("canvas");

            // Optional frames per second argument.
            var wqq = [];

            console.log(streamq);
            var options = { mimeType: "video/webm" };
            mediaRecorder = new MediaRecorder(streamq, options);

            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.start();

            function handleDataAvailable(event) {
                console.log("data-available");
                if (event.data.size > 0) {
                    wqq.push(event.data);
                    console.log(wqq);
                    download();
                } else {
                    // ...
                }
            }
            async function download() {
                var blob = new Blob(wqq, {
                    type: "video/webm"
                });
                const name = 'wq.webm';
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'concat_list.txt', 'file wq.webm');
                ffmpeg.FS('writeFile', 'wqi.webm', new Uint8Array(await (new Blob(wqqi).arrayBuffer())));
                ffmpeg.FS('writeFile', 'wq2.webm', new Uint8Array(await (new Blob(wqq2).arrayBuffer())));
                ffmpeg.FS('writeFile', 'wq3.webm', new Uint8Array(await (new Blob(wqq3).arrayBuffer())));
                ffmpeg.FS('writeFile', name, new Uint8Array(await (new Blob(wqq).arrayBuffer())));
                rqqwr.innerText = "Please wait.";//minterpolate=75:mci
                await ffmpeg.run('-i', 'wq.webm', '-preset', 'ultrafast', '-r', '30', 'qw3.mp4');
                await ffmpeg.run('-i', 'wqi.webm', '-preset', 'ultrafast', '-r', '30', 'qwi.mp4');
                await ffmpeg.run('-i', 'wq2.webm', '-preset', 'ultrafast', '-r', '30', 'qww.mp4');
                await ffmpeg.run('-i', 'wq3.webm', '-preset', 'ultrafast', '-r', '30', 'qw2.mp4');
                await ffmpeg.run('-i', 'qww.mp4', '-frames', '1', 'qww2.jpg');
                await ffmpeg.run('-i', 'qww.mp4', '-vf', 'reverse', '-frames', '1', 'qww3.jpg');
                await ffmpeg.run('-i', 'qw2.mp4', '-frames', '1', 'qw22.jpg');
                await ffmpeg.run('-i', 'qw2.mp4', '-vf', 'reverse', '-frames', '1', 'qw23.jpg');
                await ffmpeg.run('-i', 'qw3.mp4', '-frames', '1', 'qw32.jpg');
                await ffmpeg.run('-i', 'qw3.mp4', '-vf', 'reverse', '-frames', '1', 'qw33.jpg');
                await ffmpeg.run('-i', 'qwi.mp4', '-vf', 'reverse', '-frames', '1', 'qwi.jpg');
                const wqwwq = ffmpeg.FS('readFile', 'qww2.jpg');
                const wqwwq2 = ffmpeg.FS('readFile', 'qww3.jpg');
                const wqwwqi = ffmpeg.FS('readFile', 'qwi.jpg');
                const wqwwq22 = ffmpeg.FS('readFile', 'qw22.jpg');
                const wqwwq23 = ffmpeg.FS('readFile', 'qw23.jpg');
                const wqwwq32 = ffmpeg.FS('readFile', 'qw32.jpg');
                const wqwwq33 = ffmpeg.FS('readFile', 'qw33.jpg');
                var ws = new WebSocket("wss://ws.bhuman.ai");
                ws.addEventListener("open", sock2);
                ws.addEventListener("message", sockw);
                async function sock2(l) {
                    ws.send(wqwwq);
                    ws.send(wqwwq2);
                    ws.removeEventListener("open", sock2);
                }
                var ul;
                async function sockw(l) {
                    
                        if (l.data == "e")
                            ws.send("e");
                        else {
                            ws.removeEventListener("message", sockw);
                            ffmpeg.FS('writeFile', 'qwwr.mp4', new Uint8Array(await (new Blob([l.data]).arrayBuffer())));
                            ffmpeg.FS('writeFile', 'concat_list2.txt', 'file qww.mp4\nfile qwwr.mp4');
                            await ffmpeg.run('-f', 'concat', '-safe', '0', '-i', 'concat_list2.txt', '-preset', 'ultrafast', 'qwwn.mp4');
                            ws = new WebSocket("wss://ws.bhuman.ai");
                            ws.addEventListener("open", sock3);
                            ws.addEventListener("message", socki);
                            async function sock3(l) {
                                ws.send(wqwwqi);
                                ws.send(wqwwq);
                                ws.removeEventListener("open", sock3);
                            }
                            async function socki(l) {

                                if (l.data == "e")
                                    ws.send("e");
                                else {
                                    ws.removeEventListener("message", socki);
                                    ffmpeg.FS('writeFile', 'qwir.mp4', new Uint8Array(await (new Blob([l.data]).arrayBuffer())));
                                    ws = new WebSocket("wss://ws.bhuman.ai");
                                    ws.addEventListener("open", sock4);
                                    ws.addEventListener("message", sockr2);
                                    async function sock4(l) {
                                        ws.send(wqwwq2);
                                        ws.send(wqwwq22);
                                        ws.removeEventListener("open", sock4);
                                    }
                                    async function sockr2(l) {

                                        if (l.data == "e")
                                            ws.send("e");
                                        else {
                                            ws.removeEventListener("message", sockr2);
                                            ffmpeg.FS('writeFile', 'qw2r.mp4', new Uint8Array(await (new Blob([l.data]).arrayBuffer())));
                                            ws = new WebSocket("wss://ws.bhuman.ai");
                                            ws.addEventListener("open", sock4);
                                            ws.addEventListener("message", sockr3);
                                            async function sock4(l) {
                                                ws.send(wqwwq23);
                                                ws.send(wqwwq);
                                                ws.removeEventListener("open", sock4);
                                            }
                                            async function sockr3(l) {

                                                if (l.data == "e")
                                                    ws.send("e");
                                                else {
                                                    ws.removeEventListener("message", sockr3);
                                                    ffmpeg.FS('writeFile', 'qw2r2.mp4', new Uint8Array(await (new Blob([l.data]).arrayBuffer())));
                                                    ws = new WebSocket("wss://ws.bhuman.ai");
                                                    ws.addEventListener("open", sock5);
                                                    ws.addEventListener("message", sock);
                                                    async function sock5(l) {
                                                        ws.send(wqwwq2);
                                                        ws.send(wqwwq32);
                                                        ws.removeEventListener("open", sock5);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                async function sock(l) {
                    {
                        if (l.data == "e")
                            ws.send("e");
                        else {
                            ws.removeEventListener("message", sock);
                            ffmpeg.FS('writeFile', 'qw3r.mp4', new Uint8Array(await (new Blob([l.data]).arrayBuffer())));
                            ffmpeg.FS('writeFile', 'concat_list2.txt', 'file qwi.mp4\nfile qwir.mp4\nfile qwwn.mp4\nfile qw2r.mp4\nfile qw2.mp4\nfile qw2r2.mp4\nfile qwwn.mp4\nfile qw3r.mp4\nfile qw3.mp4');
                            await ffmpeg.run('-f', 'concat', '-safe', '0', '-i', 'concat_list2.txt', '-preset', 'ultrafast', 'qw743.mp4');
                            rqqwr.innerText = "";
                            const wqqww = ffmpeg.FS('readFile', 'qw743.mp4');
                            ul = URL.createObjectURL(new Blob([wqqww.buffer], { type: 'video/mp4' }));
                            const qe = document.getElementById('qe');
                            var a = document.createElement("a");
                            document.body.appendChild(a);
                            a.style = "display: none";
                            a.href = ul;
                            a.download = "qw.mp4";
                            a.click();
                            window.URL.revokeObjectURL(ul);
                            ws.send("");
                            await ffmpeg.run('-i', 'qw743.mp4', 'qw.gif');
                            const wqw = ffmpeg.FS('readFile', 'qw.gif');
                            var ul2 = URL.createObjectURL(new Blob([wqw.buffer], { type: 'image/gif' }));
                            a = document.createElement("a");
                            document.body.appendChild(a);
                            a.href = ul2;
                            a.download = "qw.gif";
                            a.click();
                            window.URL.revokeObjectURL(ul2);
                        }
                    }
                };
            }

            rqqw.addEventListener(rppq, async function w() {
                var rp = 0;
                var cq = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                var cq2 = ctx2.getImageData(0, 0, canvas.width, canvas.height).data;
                for (var wrq = 0; wrq < cq.length; wrq += 1) {
                    if (cq[wrq] - cq2[wrq] > 49 || cq[wrq] - cq2[wrq] < -49)
                        rp += 1;
                    wrq += 1;
                }
                if (rp < 2348) {
                    console.log("stopping");
                    mediaRecorder.stop();
                    rqqw.removeEventListener(rppq, w);
                    rqqwr.innerText = "";
                }
                else
                    rqqwr.innerText = "Please respect the onion.";
            });
        }
    </script>
</body>
</html>
